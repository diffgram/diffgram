<template>

  <v-dialog v-model="is_open" id="input_payload" :click:outside="close">
    <v-card elevation="1">
      <v-card-title>Input Payload:</v-card-title>
      <v-card-text>
        <v-progress-circular indeterminate v-if="loading"></v-progress-circular>
        <v-container fluid v-if="input && input.frame_packet_map">
          <highlight-code style="width: 100%; height: 100%" copy-button dark lang="json" label="json">{{ input.frame_packet_map | pretty }}</highlight-code>

        </v-container>
        <v-container fluid v-if="input && input.instance_list">
          <highlight-code style="width: 100%; height: 100%" copy-button dark lang="json" label="json">{{ input.instance_list | pretty }}</highlight-code>

        </v-container>
        <v-container fluid v-if="input && !input.instance_list && !input.frame_packet_map" class="d-flex justify-center ma-12">
          <h2>
            <v-icon x-large>mdi-dolly</v-icon>
            Empty Payload
          </h2>
        </v-container>
      </v-card-text>
    </v-card>
  </v-dialog>
</template>

<script lang="ts">
import Vue from "vue";
import axios from '../../services/customInstance';
import labels_view from '../../components/annotation/image_and_video_annotation/labels_view.vue'
import v_upload_large from '../upload_large.vue'
import CodeDiff from 'vue-code-diff/dist/vue-code-diff'

export default Vue.extend({
    name: 'input_payload_dialog',
    components: {
      labels_view,
      CodeDiff,
      v_upload_large
    },
    props: [
      'project_string_id', 
      'selected_input'
    ],
    data() {
      return {
        loading: false,
        is_open: false,
        input: undefined
      }
    },
    watch: {
      selected_input: function (newVal, oldVal) {
        if (newVal && oldVal && newVal.id != oldVal.id) {
          this.input = undefined;
          this.fetch_input_payload(newVal);
        }
      }
    },
    filters: {
      pretty: function (value) {
        return JSON.stringify(JSON.parse(value), null, 2);
      }
    },
    methods: {
      close() {
        this.input = undefined;
        this.is_open = false;
      },
      open() {
        this.is_open = true;
      },
      fetch_input_payload: async function (input) {
        try {
          this.loading = true;
          const response = await axios.post(`/api/walrus/v1/project/${this.$props.project_string_id}/input/view/${input.id}`);
          if (response.status === 200) {
            this.input = response.data.input;
            if (this.input.frame_packet_map) {
              this.input.frame_packet_map = JSON.stringify(this.input.frame_packet_map, undefined, 2)
            }
            if (this.input.instance_list) {
              this.input.instance_list = JSON.stringify(this.input.instance_list, undefined, 2)
            }


          }
        } catch (error) {
          console.error(error)
        } finally {
          this.loading = false;
        }
      }
    }
  }
) 
</script>

<style>
  code{
    width: 100%;
    height: 100% !important;
  }
</style>
