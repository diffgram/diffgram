version: "3.3"
x-diffgram-common:
  &diffgram-common
  environment:
    &diffgram-common-env
    DIFFGRAM_SYSTEM_MODE: "sandbox"
    DIFFGRAM_STATIC_STORAGE_PROVIDER: ${DIFFGRAM_STATIC_STORAGE_PROVIDER}
    USER_PASSWORDS_SECRET: ${USER_PASSWORDS_SECRET}
    SECRET_KEY: ${SECRET_KEY}
    SERVICE_ACCOUNT_FULL_PATH: "/gcp/gcp-service-account.json"
    GOOGLE_APPLICATION_CREDENTIALS: "/gcp/gcp-service-account.json"
    CLOUD_STORAGE_BUCKET: ${CLOUD_STORAGE_BUCKET}
    ML__CLOUD_STORAGE_BUCKET: ${ML__CLOUD_STORAGE_BUCKET}
    DIFFGRAM_AWS_ACCESS_KEY_ID: ${DIFFGRAM_AWS_ACCESS_KEY_ID}
    DIFFGRAM_AWS_ACCESS_KEY_SECRET: ${DIFFGRAM_AWS_ACCESS_KEY_SECRET}
    DIFFGRAM_S3_BUCKET_NAME: ${DIFFGRAM_S3_BUCKET_NAME}
    DIFFGRAM_S3_BUCKET_REGION: ${DIFFGRAM_S3_BUCKET_REGION}
    ML__DIFFGRAM_S3_BUCKET_NAME: ${ML__DIFFGRAM_S3_BUCKET_NAME}
    DIFFGRAM_AZURE_CONNECTION_STRING: ${DIFFGRAM_AZURE_CONNECTION_STRING}
    DIFFGRAM_AZURE_CONTAINER_NAME: ${DIFFGRAM_AZURE_CONTAINER_NAME}
    ML__DIFFGRAM_AZURE_CONTAINER_NAME: ${ML__DIFFGRAM_AZURE_CONTAINER_NAME}
    DIFFGRAM_MINIO_ENDPOINT_URL: ${DIFFGRAM_MINIO_ENDPOINT_URL}
    DIFFGRAM_MINIO_ACCESS_KEY_ID: ${DIFFGRAM_MINIO_ACCESS_KEY_ID}
    DIFFGRAM_MINIO_ACCESS_KEY_SECRET: ${DIFFGRAM_MINIO_ACCESS_KEY_SECRET}
    MAILGUN_KEY: ${MAILGUN_KEY}
    EMAIL_DOMAIN_NAME: ${EMAIL_DOMAIN_NAME}
    WALRUS_SERVICE_URL_BASE: ${WALRUS_SERVICE_URL_BASE}
    INTER_SERVICE_SECRET: ${INTER_SERVICE_SECRET}
    PYTHONPATH: "/app/"
    DIFFGRAM_INSTALL_FINGERPRINT: ${DIFFGRAM_INSTALL_FINGERPRINT}
    DIFFGRAM_VERSION_TAG: ${DIFFGRAM_VERSION_TAG}
    DIFFGRAM_HOST_OS: ${DIFFGRAM_HOST_OS}
    DIFFGRAM_ERROR_SEND_TRACES_IN_RESPONSE: ${DIFFGRAM_ERROR_SEND_TRACES_IN_RESPONSE}
    DIFFGRAM_SERVICE_NAME: ${DIFFGRAM_SERVICE_NAME}
    DATABASE_URL: ${DATABASE_URL}
    DATABASE_HOST: ${DATABASE_HOST}
    DATABASE_USER: ${DATABASE_USER}
    DATABASE_PASS: ${DATABASE_PASS}
    DATABASE_NAME: ${DATABASE_NAME}

    # Minio Settings
    MINIO_ROOT_USER: ${DIFFGRAM_MINIO_ACCESS_KEY_ID}
    MINIO_ROOT_PASSWORD: ${DIFFGRAM_MINIO_ACCESS_KEY_SECRET}

    # Postgres Settings
    POSTGRES_USER: ${DATABASE_USER}
    POSTGRES_PASSWORD: ${DATABASE_PASS}
    POSTGRES_DB: ${DATABASE_NAME}

services:
  dispatcher:
    image: gcr.io/diffgram-open-core/local_dispatcher:latest
    ports:
      - "0.0.0.0:8085:8085"
    expose: [ 8085 ]
    depends_on:
      - frontend
      - default
      - walrus
    environment:
      SAME_HOST: ${SAME_HOST}
    restart: always
  
  frontend:
    image: gcr.io/diffgram-open-core/frontend:${DIFFGRAM_VERSION_TAG}
    ports:
      - "0.0.0.0:8081:80"
    expose: [ 80 ]
    depends_on:
      - default
    restart: always

  walrus:
    image: gcr.io/diffgram-open-core/walrus:${DIFFGRAM_VERSION_TAG}
    ports:
      - "0.0.0.0:8082:8082"
    expose: [ 8082 ]
    depends_on:
      - db
      - default
    volumes:
      - ${GCP_SERVICE_ACCOUNT_FILE_PATH:-/dev/null}:/gcp/gcp-service-account.json
    environment:
      <<: *diffgram-common-env
    entrypoint: [ "python3", "-u", "/app/main.py" ]
    restart: always

  default:
    image: gcr.io/diffgram-open-core/default:${DIFFGRAM_VERSION_TAG}
    ports:
      - "0.0.0.0:8080:8080"
    expose: [ 8080 ]
    depends_on:
      - db
      - minio
    volumes:
      - ${GCP_SERVICE_ACCOUNT_FILE_PATH:-/dev/null}:/gcp/gcp-service-account.json
    environment:
      <<: *diffgram-common-env
    command: ["/app/db-init.sh", "${DATABASE_HOST}", "python3", "-u", "/app/main.py"]
    restart: always

  db:
    image: ${POSTGRES_IMAGE}
    hostname: db
    restart: always
    environment:
      <<: *diffgram-common-env
    volumes:
      # Default INTERNAL_POSTGRES_DIR=/var/lib/postgresql/data:Z
      - ${POSTGRES_DATA_DIR:-postgres-data}:${INTERNAL_POSTGRES_DIR:-/var/lib/postgresql/data}
    ports:
      - 5432:5432

  minio:
    image: minio/minio
    environment:
      <<: *diffgram-common-env
    ports:
      - 9000:9000
      - 9001:9001
    volumes:
      - ${MINIO_DATA_DIR:-minio-data}:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://minio:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: always

  createbuckets:
    image: minio/mc
    depends_on:
      - minio
    environment:
      <<: *diffgram-common-env
    entrypoint: >
      /bin/sh -c " 
      echo $${DIFFGRAM_S3_BUCKET_NAME}; 
      echo $${ML__DIFFGRAM_S3_BUCKET_NAME}; 
      /usr/bin/mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER}  $${MINIO_ROOT_PASSWORD};
      /usr/bin/mc mb myminio/$${DIFFGRAM_S3_BUCKET_NAME}; 
      /usr/bin/mc mb myminio/$${ML__DIFFGRAM_S3_BUCKET_NAME}; 
      exit 0; "

volumes:
  static: {}
  minio-data: {}
  postgres-data: {}
